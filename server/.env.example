# ─── Core ─────────────────────────────────────────────────────────────────────
# HTTP port the server listens on
PORT=3001
# Set to 'production' to enable HSTS, strict CORS, and hide /metrics
NODE_ENV=development
# Set to 'true' if behind a reverse proxy that sets X-Forwarded-For (used for IP rate limiting)
TRUST_PROXY=false
# Comma-separated list of allowed CORS origins (required in production)
ALLOWED_ORIGINS=http://localhost:5173

# ─── Supabase ─────────────────────────────────────────────────────────────────
# Project REST API URL (find it in the Supabase dashboard → Settings → API)
SUPABASE_URL=https://your-project-ref.supabase.co
# Service role key — has full DB access, bypasses RLS. NEVER expose to the browser.
SUPABASE_SERVICE_ROLE_KEY=your-supabase-service-role-key
# Anon/public key — used only by scripts (e.g. load-profile.mjs) that mimic client auth
SUPABASE_ANON_KEY=your-supabase-anon-key
# Required for migration-drift checks (supabase CLI link)
SUPABASE_PROJECT_REF=your-project-ref
# Personal access token for Supabase CLI (supabase link, db diff)
SUPABASE_ACCESS_TOKEN=your-supabase-access-token

# ─── LLM ──────────────────────────────────────────────────────────────────────
# Primary LLM provider: 'zai' (default) or 'anthropic'
LLM_PROVIDER=zai

# Z.AI (primary provider)
ZAI_API_KEY=your-zai-api-key
# Override the Z.AI base URL (defaults to https://api.z.ai/api/paas/v4)
# ZAI_BASE_URL=https://api.z.ai/api/paas/v4

# Z.AI model overrides (defaults shown; override only if needed)
# ZAI_MODEL_PRIMARY=glm-4.7
# ZAI_MODEL_MID=glm-4.5-air
# ZAI_MODEL_ORCHESTRATOR=glm-4.7-flashx
# ZAI_MODEL_LIGHT=glm-4.7-flash

# Anthropic (optional fallback — only needed when LLM_PROVIDER=anthropic)
# ANTHROPIC_API_KEY=sk-ant-...

# Max tokens per LLM call (default 8192)
# MAX_TOKENS=8192

# Perplexity — used by the research agent for web search
PERPLEXITY_API_KEY=your-perplexity-api-key

# ─── Feature Flags ────────────────────────────────────────────────────────────
# All default to true ('1' or 'true' to enable, '0' or 'false' to disable)
# FF_INTAKE_QUIZ=true
# FF_RESEARCH_VALIDATION=true
# FF_GAP_ANALYSIS_QUIZ=true
# FF_QUALITY_REVIEW_APPROVAL=true
# FF_GUIDED_SUGGESTIONS=true

# ─── Performance / Limits ─────────────────────────────────────────────────────
# Structured logging level: trace | debug | info | warn | error (default: debug in dev, info in prod)
# LOG_LEVEL=info

# Bearer token required to access GET /metrics in production (omit to allow unauthenticated access in dev)
# METRICS_KEY=your-metrics-bearer-token

# Heap threshold in MB — server returns 503 above this value (0 = disabled)
# MAX_HEAP_USED_MB=0

# TTL for the /health endpoint DB check cache in ms (default 5000)
# HEALTH_CHECK_CACHE_TTL_MS=5000

# Max in-flight rate-limit buckets (default 50000)
# MAX_RATE_LIMIT_BUCKETS=50000

# Max concurrent in-process pipeline runs (default 5000)
# MAX_IN_PROCESS_PIPELINES=5000
# Max running pipelines globally tracked in DB (default 1500)
# MAX_RUNNING_PIPELINES_GLOBAL=1500
# Max concurrent pipelines per user (default 3)
# MAX_RUNNING_PIPELINES_PER_USER=3

# Section revision gate timeout in ms (default 300000 = 5 min)
# SECTION_REVISION_TIMEOUT_MS=300000
# Max characters accepted from user feedback in section review (default 2000)
# MAX_SECTION_REVIEW_FEEDBACK_CHARS=2000
# Max characters accepted for direct section edits (default 50000)
# MAX_SECTION_REVIEW_EDITED_CHARS=50000
# Max section review refinement passes (default 5)
# MAX_SECTION_REVIEW_REFINEMENTS=5
# Max characters in a review token (default 128)
# MAX_SECTION_REVIEW_TOKEN_CHARS=128
# Max refinement ID length in chars (default 64)
# MAX_SECTION_REVIEW_REFINEMENT_ID_CHARS=64

# Max body bytes for POST /api/pipeline/start (default 220000)
# MAX_PIPELINE_START_BODY_BYTES=220000
# Max body bytes for POST /api/pipeline/respond (default 120000)
# MAX_PIPELINE_RESPOND_BODY_BYTES=120000

# Section context sanitization limits
# MAX_SECTION_CONTEXT_EVIDENCE_ITEMS=20
# MAX_SECTION_CONTEXT_KEYWORDS=40
# MAX_SECTION_CONTEXT_GAPS=40
# MAX_SECTION_CONTEXT_ORDER_ITEMS=40
# MAX_SECTION_CONTEXT_TEXT_CHARS=700
# MAX_SECTION_CONTEXT_BLUEPRINT_BYTES=120000
# MAX_SECTION_CONTEXT_SUGGESTIONS=5
# MAX_SUGGESTION_QUESTION_TEXT_CHARS=300
# MAX_SUGGESTION_CONTEXT_CHARS=200
# MAX_SUGGESTION_OPTION_LABEL_CHARS=40
# MAX_SUGGESTION_ID_CHARS=80

# Max queued panel persist operations (default 5000)
# MAX_QUEUED_PANEL_PERSISTS=5000

# Stale pipeline recovery settings
# STALE_RECOVERY_COOLDOWN_MS=60000
# STALE_RECOVERY_BATCH_SIZE=200

# ─── Error Tracking ──────────────────────────────────────────────────────────
# Sentry DSN for error reporting (omit to disable)
# SENTRY_DSN=https://your-dsn@o123.ingest.sentry.io/456

# ─── Optional: Staging Ready Check ────────────────────────────────────────────
# Used by scripts/check-ready.mjs and the staging-ready CI job
# READY_CHECK_URL=https://staging-api.example.com
# READY_CHECK_TIMEOUT_MS=45000
# READY_CHECK_INTERVAL_MS=1000
